<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  margin: 0;
}

path {
  fill: rgba(0,0,0,0.1);
  stroke-width: 0.000001px;
  stroke: black;
}

</style>
<body>
<script src="//d3js.org/d3.v4.0.0-alpha.50.min.js"></script>
<script src="//d3js.org/d3-scale-chromatic.v0.3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script src="//d3js.org/d3-tile.v0.0.min.js"></script>
<script>

var width = Math.max(960, window.innerWidth),
    height = Math.max(500, window.innerHeight),
    stationColor = d3.scaleSequential(d3.interpolateOranges);
    stationSize = 10;

var tile = d3.tile()
    .size([width, height]);

var projection = d3.geoMercator()
    .scale((1 << 12) / 2 / Math.PI)
    .translate([width / 2, height / 2]);

var voronoi = d3.voronoi()
    .x(function(d) { return d.projected[0]; }) 
    .y(function(d) { return d.projected[1]; })
    .extent([[-1, -1], [width + 1, height + 1]]);

var center = projection([-100, 40]);

var path = d3.geoPath()
    .projection(projection);

var zoom = d3.zoom()
    .on("zoom", zoomed);

// With the center computed, now adjust the projection such that
// it uses the zoom behavior’s translate and scale.
projection
    .scale(1 / 2 / Math.PI)
    .translate([0, 0]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var raster = svg.append("g")
    .attr("opacity", 0.4);

var vector = svg.append("g");

var legend = svg.append("g")
  .attr("transform", "translate(10, 10)");

svg.call(zoom);

// Zoom into Bangalore.
svg.call(zoom.transform, d3.zoomIdentity
  .translate(-41951.175, 7402.282)
  .scale(198668));

zoomed();

function zoomed() {
  var transform = d3.zoomTransform(svg.node());

  var tiles = tile
    .scale(transform.k)
    .translate([transform.x, transform.y])
    ();

  vector.attr("transform", transform);

  var image = raster
      .attr("transform", "scale(" + tiles.scale + ")translate(" + tiles.translate + ")")
    .selectAll("image")
      .data(tiles, function(d) { return d; });

  image.exit()
      .remove();

  image.enter().append("image")
//      .attr("xlink:href", function(d) { return "http://a.tile.openstreetmap.org/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
      .attr("xlink:href", function(d) { return "http://stamen-tiles-a.a.ssl.fastly.net/toner-lite/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
      .attr("width", 1)
      .attr("height", 1)
      .attr("x", function(d) { return d[0]; })
      .attr("y", function(d) { return d[1]; });

  vector.selectAll("circle")
    .attr("r", stationSize / transform.k);

  console.log(stationSize / transform.k);
}

d3.json("data.json", function (data){
  var transform = d3.zoomTransform(svg.node());
  data = data.result.map(type);
  data = data.filter(function (d){return d.T;})
  stationColor.domain(d3.extent(data,function(d){return d.T;}));

  var circle = vector.selectAll("g")
    .data(data)
    .enter().append("g");

  var cell = circle.append("path")
    .data(voronoi.polygons(data))
      .attr("d", renderCell)
      .attr("id", function(d, i) { return "cell-" + i; });

  circle.append("clipPath")
      .attr("id", function(d, i) { return "clip-" + i; })
    .append("use")
      .attr("xlink:href", function(d, i) { return "#cell-" + i; });

  circle.append("circle")
      .attr("clip-path", function(d, i) { return "url(#clip-" + i + ")"; })
      .attr("fill", function(d){return stationColor(d.T)})
      .attr("cx", function (d){ return d.projected[0]; }) 
      .attr("cy", function (d){ return d.projected[1]; })
      .attr("r", stationSize / transform.k)
      .append("title")
      .text(function(d){return d.address;});

  var legendBackground = legend.append("rect")
    .attr("width", 90)
    .attr("height", 190)
    .attr("rx", 10)
    .attr("ry", 10)
    .attr("fill", "white")
    .attr("opacity", 0.8);

  var legendEntries = legend.selectAll(".legend-entry")
      .data(stationColor.ticks().reverse())
    .enter().append("g")
      .attr("class", "legend-entry")
      .attr("transform", function(d, i) {
        return "translate(10," + (10 + i * 25) + ")";
      });
 
  legendEntries.append("rect")
      .attr("width", 20)
      .attr("height", 20)
      .attr("fill", stationColor);

  legendEntries.append("text")
      .attr("x", 26)
      .attr("y", 10)
      .attr("dy", ".35em")
      .text(function (d){ return d + " °C"; }); 

});

function renderCell(d) {
  return d == null ? null : "M" + d.join("L") + "Z";
}

function type(d){
  d.T = +d.T;
  d.projected = projection([ +d.longitude,+d.latitude]);
  return d;
}

d3.select(self.frameElement).style("height", height + "px");

</script>
    
